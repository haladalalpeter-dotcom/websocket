import express from 'express';
import { WebSocketServer } from 'ws';
import cors from 'cors';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;
const COUNTERS_FILE = path.join(__dirname, 'counters.json');

// Use CORS
app.use(cors());

// Load counters from file
let counters = {};
try {
  const data = fs.readFileSync(COUNTERS_FILE, 'utf8');
  counters = JSON.parse(data);
} catch (err) {
  console.log('No existing counters file, starting fresh');
}

// Save counters to file
function saveCounters() {
  fs.writeFileSync(COUNTERS_FILE, JSON.stringify(counters, null, 2));
}

// Map of userId to Set of WebSocket connections
const connections = new Map();

// Create WebSocket server
const server = app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

const wss = new WebSocketServer({ server });

// WebSocket connection handler
wss.on('connection', (ws) => {
  let userId = null;

  ws.on('message', (data) => {
    try {
      const message = JSON.parse(data.toString());
      if (message.type === 'register' && message.userId) {
        userId = message.userId;
        // Initialize counter if not exists
        if (!(userId in counters)) {
          counters[userId] = 0;
        }
        // Add connection to the set
        if (!connections.has(userId)) {
          connections.set(userId, new Set());
        }
        connections.get(userId).add(ws);
        // Send current counter
        ws.send(JSON.stringify({ type: 'update', counter: counters[userId] }));
      }
    } catch (err) {
      console.error('Invalid message:', err);
    }
  });

  ws.on('close', () => {
    if (userId && connections.has(userId)) {
      connections.get(userId).delete(ws);
      // Clean up if no connections left
      if (connections.get(userId).size === 0) {
        connections.delete(userId);
      }
    }
  });
});

// HTTP endpoint to increment counter
app.get('/open', (req, res) => {
  const userId = req.query.id;
  if (!userId) {
    return res.status(400).json({ error: 'Missing userId' });
  }

  // Initialize if not exists
  if (!(userId in counters)) {
    counters[userId] = 0;
  }

  // Increment
  counters[userId] += 1;

  // Save to file
  saveCounters();

  // Broadcast update to all connections for this userId
  if (connections.has(userId)) {
    const message = JSON.stringify({ type: 'update', counter: counters[userId] });
    connections.get(userId).forEach((ws) => {
      if (ws.readyState === ws.OPEN) {
        ws.send(message);
      }
    });
  }

  res.json({ success: true, counter: counters[userId] });
});
