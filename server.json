import express from 'express';
import { WebSocketServer } from 'ws';
import cors from 'cors';
import Database from 'better-sqlite3';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;
const DB_PATH = path.join(__dirname, 'counters.db');

// Use CORS
app.use(cors());

// Initialize SQLite database
const db = new Database(DB_PATH);

// Create table if not exists
db.exec(`
  CREATE TABLE IF NOT EXISTS counters (
    userId TEXT PRIMARY KEY,
    counter INTEGER DEFAULT 0
  )
`);

// Prepare statements
const getCounterStmt = db.prepare('SELECT counter FROM counters WHERE userId = ?');
const upsertCounterStmt = db.prepare(`
  INSERT INTO counters (userId, counter) VALUES (?, ?)
  ON CONFLICT(userId) DO UPDATE SET counter = excluded.counter
`);

// Map of userId to Set of WebSocket connections
const connections = new Map();

// Create WebSocket server
const server = app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

const wss = new WebSocketServer({ server });

// WebSocket connection handler
wss.on('connection', (ws) => {
  let userId = null;

  ws.on('message', (data) => {
    try {
      const message = JSON.parse(data.toString());
      if (message.type === 'register' && message.userId) {
        userId = message.userId;
        // Get current counter from DB
        let counter = 0;
        const row = getCounterStmt.get(userId);
        if (row) {
          counter = row.counter;
        }
        // Add connection to the set
        if (!connections.has(userId)) {
          connections.set(userId, new Set());
        }
        connections.get(userId).add(ws);
        // Send current counter
        ws.send(JSON.stringify({ type: 'update', counter }));
      }
    } catch (err) {
      console.error('Invalid message:', err);
    }
  });

  ws.on('close', () => {
    if (userId && connections.has(userId)) {
      connections.get(userId).delete(ws);
      // Clean up if no connections left
      if (connections.get(userId).size === 0) {
        connections.delete(userId);
      }
    }
  });
});

// HTTP endpoint to increment counter
app.get('/open', (req, res) => {
  const userId = req.query.id;
  if (!userId) {
    return res.status(400).json({ error: 'Missing userId' });
  }

  // Get current counter
  let counter = 0;
  const row = getCounterStmt.get(userId);
  if (row) {
    counter = row.counter;
  }

  // Increment
  counter += 1;

  // Save to DB
  upsertCounterStmt.run(userId, counter);

  // Broadcast update to all connections for this userId
  if (connections.has(userId)) {
    const message = JSON.stringify({ type: 'update', counter });
    connections.get(userId).forEach((ws) => {
      if (ws.readyState === ws.OPEN) {
        ws.send(message);
      }
    });
  }

  res.json({ success: true, counter });
});
